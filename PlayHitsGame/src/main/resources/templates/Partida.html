<!DOCTYPE html>
<!--
Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
Click nbfs://nbhost/SystemFileSystem/Templates/Other/html.html to edit this template
-->
<html lang="es" xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Partida</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>           
            <div>            
               <table border="2" > 
                   <tr>
                   <p th:text="${usuarioSesion.alias}"/>
                   <input type="hidden" id="usuario" value="${usuarioSesion.usuario}"/>
                   </tr>
                   <tr>
                       <td><p>PARTIDA</p></td>
                       <td>
                           <p th:each="txt : ${partidaSesion.descripcion}" th:text="${txt}"></p>
                       </td>
                       <td>
                           <p th:text="'Usuarios que han respondido'"/>
                           <div id="mensajesSockets">
                               
                           </div>                           
                       </td>
                   </tr>
                   <tr th:each="ronda : ${partidaSesion.rondas}">                                              
                         <div th:if="${partidaSesion.rondaActual  == ronda.numero}">
                            <td th:text="'RONDA ' + ${ronda.numero}"></td>  
                            <td>
                                <audio controls>
                                    <source th:src="${ronda.cancion.spotifyplay}" type="audio/mpeg"/>
                                </audio>                              
                                <form method="post" action="/partida" >                
                                    <input type="number" name="anyo" required="required"/>          
                                    <input type="submit" value="Responder"/>                
                                </form>  
                            </td>
                         </div>    
                   </tr> 
                   <tr th:each="ronda : ${partidaSesion.rondas}">                         
                         <div th:if="${ronda.estaCompletada()}">
                            <td th:text="'RONDA ' + ${ronda.numero}"></td> 
                            <td>
                                <p th:text="'Titulo: ' + ${ronda.cancion.titulo}"></p>
                                <p th:text="'Interprete: ' + ${ronda.cancion.interprete}"></p>
                                <p th:text="'Año: ' + ${ronda.cancion.anyo}"></p>
                            </td>
                            <td>
                                <img th:src="${ronda.cancion.spotifyimagen}" alt="PLAYHITSGAME" width="100" height="100" />
                            </td> 
                            <div th:each="resp : ${respuestas}">
                                <td th:if="${resp.ronda.numero == ronda.numero}">
                                    <p th:text="Enviado"/>
                                    <p th:text="'Año ' + ${resp.anyo}"/>
                                </td>
                            </div>
                         </div>
                         <div th:if="${partidaSesion.rondaActual != ronda.numero && !ronda.estaCompletada()}">
                             <td th:text="'RONDA ' + ${ronda.numero}"></td> 
                             <td>
                                <p>Pendiente</p>
                            </td> 
                         </div>                     
                   </tr>      
                </table>   
            
            </div>
        <script th:inline="javascript">
            let socket = new WebSocket("ws://localhost:8080/websocket");
            socket.onmessage = function(event){
                let mensajesSockets = document.getElementById("mensajesSockets");
                mensajesSockets.innerHTML += '<p>' + event.data + '</p>';
            };
            //El sendMessage no hace falta ya lo hara el servlet
            // sino habria que hacer boton con onclick="sendMessage()"
            function sendMessage(){
                let username = document.getElementById("usuario");
                let mensaje = username.value;
                socket.send(mensaje);                
            };
            
        </script>    
    </body>
</html>
